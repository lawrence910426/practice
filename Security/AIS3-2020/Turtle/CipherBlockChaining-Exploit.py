import requests
from bs4 import BeautifulSoup
import base64
import copy

session = requests.Session()
result = session.get("https://turtowl.ais3.org/")
soup = BeautifulSoup(result.text, features="html.parser")
token = soup.find("input", {"name":"csrf_token"})['value']
print(token)

def check_valid(token):
    result = session.post("https://turtowl.ais3.org/?action=login", data={
        "csrf_token": base64.b64encode(token),
        "username": "admin",
        "password": "admin"
    })
    if result.text == '<script>; document.location.replace("\/");</script>':
        print("GOOD")
        return False
    elif 'Uncaught Exception: token decryption failed in /var/www/html/csrf.php:25' in result.text:
        return False
    elif 'invalid csrf_token' in result.text:
        return True
    else:
        print(result.text)

token = base64.b64decode(token)
cipher = [bytes(token[i * 16:i * 16 + 16]) for i in range(4)]
plaintext = [[0 for j in range(16)] for i in range(4)]
check_valid(cipher[0] + cipher[1] + cipher[2] + cipher[3])

for chunk in range(3):
    payload = bytearray(16)
    for offset in range(1, 17):
        for i in range(offset):
            payload[15 - i] ^= offset
        for guess in range(256):
            payload[-offset] ^= guess
            if check_valid(bytes(payload) + cipher[chunk + 1]):
                plaintext[chunk][-offset] = guess ^ cipher[chunk][-offset]
                payload[-offset] ^= guess
                print(plaintext[chunk])
                print(guess) 
            payload[-offset] ^= guess
        for i in range(offset):
            payload[15 - i] ^= offset
    ans = ""
    for i in range(4):
        for j in range(16):
            ans += chr(plaintext[i][j])
    print(ans)
